<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Chẩn Đoán Bệnh Phổi</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../static/css/styles.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="../static/js/scripts.js" defer></script>
</head>
<body>

    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fa-solid fa-heart-pulse"></i> Chẩn Đoán Bệnh Phổi
            </a>
            <div class="d-flex">
                <span class="badge bg-light text-dark border me-2">
                    <i class="fa-solid fa-server"></i> Model: GCN + EfficientNet-B4
                </span>
                <span class="badge bg-success bg-opacity-10 text-success border border-success">
                    <i class="fa-solid fa-check-circle"></i> Hệ thống sẵn sàng
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-lg-4">
                <div class="medical-card">
                    <div class="card-header">
                        <i class="fa-solid fa-upload"></i> Tải Ảnh X-Quang
                    </div>
                    <div class="card-body">
                        <input type="file" id="fileInput" accept="image/*" hidden>
                        <div class="upload-zone" id="dropZone">
                            <div class="upload-icon"><i class="fa-solid fa-cloud-arrow-up"></i></div>
                            <h6 class="fw-bold">Kéo thả hoặc Nhấn để tải ảnh</h6>
                            <p class="text-muted small mb-0">Hỗ trợ định dạng: PNG, JPG, JPEG</p>
                        </div>
                        
                        <div id="previewContainer" class="mt-3 d-none text-center">
                            <div class="position-relative">
                                <img id="previewImg" src="" class="img-fluid rounded border" style="max-height: 200px;">
                                <button onclick="resetApp()" class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1" title="Xóa ảnh">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                            <p class="small text-muted mt-2" id="fileName"></p>
                        </div>

                        <button id="predictBtn" class="btn btn-primary w-100 mt-3 py-2 fw-bold" style="background-color: var(--primary-color); border:none;" disabled>
                            <i class="fa-solid fa-microscope"></i> PHÂN TÍCH ẢNH
                        </button>
                        
                        <button id="resetBtn" onclick="resetApp()" class="btn btn-outline-secondary w-100 mt-2 py-2 d-none">
                            <i class="fa-solid fa-rotate-right"></i> QUÉT ẢNH MỚI
                        </button>
                    </div>
                </div>

                <div class="medical-card">
                    <div class="card-header">
                        <i class="fa-solid fa-circle-info"></i> Thông tin hệ thống
                    </div>
                    <div class="card-body small text-muted">
                        <p class="mb-1"><strong>Ngưỡng nhạy (Thresholds):</strong></p>
                        <ul class="ps-3 mb-0">
                            <li>Tràn khí màng phổi: >30%</li>
                            <li>Xẹp phổi / Đông đặc: >30%</li>
                            <li>Bệnh phổi kẽ (ILD): >30%</li>
                            <li>Nốt mờ / Khối u / Vôi hóa: >35%</li>
                            <li>Thâm nhiễm: >40%</li>
                            <li>Xơ phổi / Mờ phổi: >45%</li>
                            <li>Tim to / Tràn dịch / Phình động mạch chủ / Dày màng phổi / Khác: >50%</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="col-lg-8">
                <div id="loading" class="text-center py-5 d-none">
                    <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;"></div>
                    <h5 class="mt-3 text-muted">AI đang phân tích phim phổi...</h5>
                    <p class="small text-muted">Đang tìm kiếm dấu hiệu của 14 bệnh lý phổi</p>
                </div>

                <div id="resultsPanel" class="d-none">
                    
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold text-secondary">Kết Quả Chẩn Đoán</h5>
                        <button onclick="exportPDF()" class="btn btn-sm btn-outline-primary">
                            <i class="fa-solid fa-file-pdf"></i> Xuất Báo Cáo
                        </button>
                    </div>

                    <div id="statusAlert" class="alert mb-3 shadow-sm" role="alert"></div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="medical-card h-100">
                                <div class="card-header">
                                    <i class="fa-solid fa-eye"></i> Bản đồ nhiệt AI (Grad-CAM)
                                </div>
                                <div class="card-body p-2">
                                    <div class="result-img-container">
                                        <img id="overlayImg" src="" class="result-img" alt="Heatmap">
                                        <span class="img-label">Vùng AI Nghi Ngờ</span>
                                    </div>
                                    <div class="mt-2 text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-secondary" onclick="showOriginal()">Ảnh Gốc</button>
                                            <button type="button" class="btn btn-outline-secondary active" onclick="showHeatmap()">Bản đồ nhiệt</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="medical-card h-100">
                                <div class="card-header">
                                    <i class="fa-solid fa-list-check"></i> Xác Suất Bệnh Lý
                                </div>
                                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                                    <div id="probsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="emptyState" class="text-center py-5 text-muted">
                    <i class="fa-solid fa-user-doctor fa-4x mb-3" style="color: #e0e0e0;"></i>
                    <h4>Sẵn Sàng Chẩn Đoán</h4>
                    <p>Vui lòng tải lên ảnh X-Quang ngực để bắt đầu phân tích.</p>
                </div>

            </div>
        </div>

        <div class="footer-disclaimer">
            <strong>KHUYẾN CÁO:</strong> Công cụ AI này chỉ phục vụ mục đích tham khảo. 
            Nó không thay thế cho chẩn đoán của Bác sĩ chuyên khoa. Mọi kết quả cần được kiểm chứng lâm sàng.
        </div>
    </div>

    <div id="pdf-report-template" style="display: none;">
        <div class="pdf-container" style="padding: 20px; font-family: 'Inter', 'Arial', sans-serif;">
            <div style="border-bottom: 2px solid #006064; padding-bottom: 10px; margin-bottom: 20px; display: flex; justify-content: space-between;">
                <h2 style="color: #006064; margin: 0;">Báo Cáo Chẩn Đoán AI</h2>
                <div style="text-align: right;">
                    <small style="color: #666;">Thời gian: <span id="pdf-date"></span></small><br>
                    <small style="color: #666;">Hệ thống chẩn đoán bệnh phổi</small>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                <div style="flex: 1; text-align: center;">
                    <p style="font-weight: bold; margin-bottom: 5px;">Ảnh X-Quang Gốc</p>
                    <img id="pdf-orig-img" src="" style="max-width: 100%; max-height: 250px; border: 1px solid #ddd;">
                </div>
                <div style="flex: 1; text-align: center;">
                    <p style="font-weight: bold; margin-bottom: 5px;">Bản Đồ Nhiệt Tổn Thương</p>
                    <img id="pdf-heatmap-img" src="" style="max-width: 100%; max-height: 250px; border: 1px solid #ddd;">
                </div>
            </div>

            <h4 style="color: #2c3e50; border-bottom: 1px solid #eee; padding-bottom: 5px;">Kết Quả Phân Tích</h4>
            <table class="table table-striped table-bordered" style="width: 100%; margin-top: 10px; font-size: 14px;">
                <thead>
                    <tr style="background-color: #f8f9fa;">
                        <th>Bệnh Lý / Dấu Hiệu</th>
                        <th>Độ Tin Cậy AI</th>
                        <th>Trạng Thái</th>
                    </tr>
                </thead>
                <tbody id="pdf-table-body">
                </tbody>
            </table>

            <div style="margin-top: 30px; padding: 10px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 5px; font-size: 12px; color: #856404;">
                <strong>Lưu ý:</strong> Báo cáo này được tạo tự động bởi trí tuệ nhân tạo. Kết quả này không phải là chẩn đoán y khoa chính thức. Vui lòng tham khảo ý kiến bác sĩ để có kết luận chính xác.
            </div>
        </div>
    </div>
</body>
</html>